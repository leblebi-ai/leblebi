# Data Model: Multi-Agent Workspace Management

**Feature**: 003-us2-multi-agent-workspace  
**Date**: 2026-02-18  
**Version**: 1.0.0

---

## Entity Relationship Diagram

```
┌─────────────────────┐
│    Workspace        │
├─────────────────────┤
│ - id: String        │
│ - identity          │
│ - gatewayConnectionId│
│ - createdAt         │
│ - updatedAt         │
│ - deletedAt?        │
└─────────────────────┘
         │
         │ 1:N
         ▼
┌─────────────────────┐
│   Conversation      │
├─────────────────────┤
│ - id: String        │
│ - workspaceId       │◄─── Foreign key
│ - title             │
│ - createdAt         │
│ - lastMessageAt     │
└─────────────────────┘
         │
         │ 1:N
         ▼
┌─────────────────────┐
│      Message        │
├─────────────────────┤
│ - id: String        │
│ - conversationId    │◄─── Foreign key
│ - content           │
│ - sender            │
│ - timestamp         │
│ - status            │
└─────────────────────┘

┌─────────────────────┐
│ GatewayConnection   │◄─── From US1
├─────────────────────┤
│ - id: String        │
│ - url               │
│ - bearerToken       │
│ - providerType      │
└─────────────────────┘
```

---

## Entity Definitions

### Workspace (New)

**Purpose**: Represents a distinct agent configuration context with identity, settings, and conversation history.

**Fields**:
```dart
class Workspace {
  final String id;                    // Unique identifier (UUID)
  final WorkspaceIdentity identity;   // Agent identity configuration
  final String gatewayConnectionId;   // Reference to GatewayConnection
  final DateTime createdAt;           // Workspace creation timestamp
  final DateTime? updatedAt;          // Last modification timestamp
  final DateTime? deletedAt;          // Soft delete timestamp (null = active)
  
  // Computed properties
  bool get isDeleted => deletedAt != null;
  bool get isActive => deletedAt == null;
  int get daysInTrash => deletedAt != null 
    ? DateTime.now().difference(deletedAt!).inDays 
    : 0;
}
```

**Validation Rules**:
- `id`: Required, non-empty, immutable
- `identity`: Required, must have non-empty name
- `gatewayConnectionId`: Required, must reference existing GatewayConnection
- `deletedAt`: Optional, set only on delete, cleared on restore

**State Transitions**:
```
[Active] ──delete()──> [Trash] ──restore()──> [Active]
   │                        │
   │                        └──auto-purge(30d)──> [Deleted]
   │
   └──permanentDelete()──> [Deleted]
```

---

### WorkspaceIdentity (Value Object)

**Purpose**: Encapsulates agent identity configuration within a workspace.

**Fields**:
```dart
class WorkspaceIdentity {
  final String name;              // Workspace display name (e.g., "Work", "Personal")
  final String? persona;          // Agent personality description
  final String? systemPrompt;     // Custom system instructions for the agent
  final Map<String, dynamic>? toolConfigs; // Future: tool configurations
  
  // Validation
  bool get hasPersona => persona != null && persona!.isNotEmpty;
  bool get hasSystemPrompt => systemPrompt != null && systemPrompt!.isNotEmpty;
}
```

**Validation Rules**:
- `name`: Required, 1-100 characters, trimmed
- `persona`: Optional, max 1000 characters
- `systemPrompt`: Optional, max 4000 characters
- `toolConfigs`: Optional, reserved for US3

---

### Conversation (Extended from US1)

**Purpose**: A conversation thread within a specific workspace.

**Changes from US1**:
- Added `workspaceId` foreign key
- Conversations are now scoped to a workspace
- Deleting a workspace cascades to its conversations

**Updated Fields**:
```dart
class Conversation {
  final String id;
  final String workspaceId;      // NEW: Foreign key to Workspace
  final String? title;
  final DateTime createdAt;
  final DateTime lastMessageAt;
  // ... other fields from US1
}
```

**Cascade Behavior**:
- Workspace delete (soft) → Conversations remain accessible in trash
- Workspace restore → Conversations become accessible again
- Workspace permanent delete → All conversations permanently deleted

---

### Message (No Changes)

**Purpose**: Individual message within a conversation.

**Note**: No changes from US1. Messages reference conversations, which reference workspaces.

---

## Storage Schema

### Hive Boxes

```dart
// Box names
const String workspacesBox = 'workspaces';
const String conversationsBox = 'conversations';
const String messagesBox = 'messages';

// Type adapters (generated by Zuraffa)
class WorkspaceAdapter extends TypeAdapter<Workspace> { ... }
class WorkspaceIdentityAdapter extends TypeAdapter<WorkspaceIdentity> { ... }
class ConversationAdapter extends TypeAdapter<Conversation> { ... }
class MessageAdapter extends TypeAdapter<Message> { ... }
```

### Secure Storage Keys

```dart
// Gateway credentials per workspace (encrypted)
// Format: {prefix}_{workspaceId}
const String gatewayTokenPrefix = 'gateway_token';
const String gatewayUrlPrefix = 'gateway_url';

// Example keys:
// 'gateway_token_550e8400-e29b-41d4-a716-446655440000'
// 'gateway_url_550e8400-e29b-41d4-a716-446655440000'
```

---

## Repository Interfaces

### WorkspaceRepository (New)

```dart
abstract class WorkspaceRepository {
  /// Create a new workspace
  Future<Workspace> create(Workspace workspace);
  
  /// Get workspace by ID
  Future<Workspace?> get(String id);
  
  /// Get all active workspaces (not deleted)
  Future<List<Workspace>> getList();
  
  /// Get all workspaces including deleted (for Trash view)
  Future<List<Workspace>> getAllWithDeleted();
  
  /// Update workspace
  Future<Workspace> update(Workspace workspace);
  
  /// Soft delete workspace (move to trash)
  Future<void> delete(String id);
  
  /// Restore workspace from trash
  Future<Workspace> restore(String id);
  
  /// Permanent delete workspace and all related data
  Future<void> permanentDelete(String id);
  
  /// Purge expired trash (workspaces deleted > 30 days ago)
  Future<int> purgeExpiredTrash();
}
```

---

## Data Flow Diagrams

### Create Workspace Flow

```
User → CreateWorkspaceView → WorkspaceController → CreateWorkspaceUseCase
                                                      │
                                                      ▼
                                         WorkspaceRepository.create()
                                                      │
                                                      ▼
                                         HiveDatasource.insert(workspace)
                                                      │
                                                      ▼
                                         SecureStorageDatasource.setCredentials()
                                                      │
                                                      ▼
                                         Update UI with new workspace list
```

### Switch Workspace Flow

```
User → WorkspaceSwitcher → WorkspaceController → SwitchWorkspaceUseCase
                                                    │
                                                    ▼
                                       WorkspaceRepository.get(id)
                                                    │
                                                    ▼
                                       ConversationRepository.getByWorkspace(id)
                                                    │
                                                    ▼
                                       Update UI: Load new workspace conversations
```

### Delete Workspace Flow

```
User → WorkspaceListItem (delete) → WorkspaceController → DeleteWorkspaceUseCase
                                                             │
                                                             ▼
                                                WorkspaceRepository.delete(id)
                                                             │
                                                             ▼
                                                Set workspace.deletedAt = DateTime.now()
                                                             │
                                                             ▼
                                                HiveDatasource.update(workspace)
                                                             │
                                                             ▼
                                                Refresh workspace list (exclude deleted)
```

### Purge Expired Trash (Background Job)

```
App Startup → PurgeTrashJob → WorkspaceRepository.purgeExpiredTrash()
                                   │
                                   ▼
                      Query: WHERE deletedAt < (now - 30 days)
                                   │
                                   ▼
                      For each expired workspace:
                        - Delete conversations (cascade)
                        - Delete messages (cascade)
                        - Delete secure storage credentials
                        - Remove from Hive
                                   │
                                   ▼
                      Log: "Purged N expired workspaces"
```

---

## Migration Strategy

### From US1 (Connect and Chat)

**Current State (US1)**:
- Single conversation context
- Gateway connection is global
- No workspace concept

**Target State (US2)**:
- Multiple workspaces
- Each workspace has its own conversations
- Gateway connection referenced per workspace

**Migration Steps**:
1. Create Workspace entity with Zuraffa
2. Add `workspaceId` field to Conversation entity
3. Migrate existing conversation to "Default" workspace:
   ```dart
   // Migration script
   final defaultWorkspace = Workspace(
     id: 'default',
     identity: WorkspaceIdentity(name: 'Default'),
     gatewayConnectionId: existingGatewayConnection.id,
     createdAt: DateTime.now(),
   );
   await workspaceRepository.create(defaultWorkspace);
   
   // Update existing conversations
   final conversations = await conversationRepository.getList();
   for (final conv in conversations) {
     conv.workspaceId = defaultWorkspace.id;
     await conversationRepository.update(conv);
   }
   ```

---

## Testing Data Fixtures

### Sample Workspace

```dart
final testWorkspace = Workspace(
  id: 'test-workspace-1',
  identity: WorkspaceIdentity(
    name: 'Test Workspace',
    persona: 'Helpful coding assistant',
    systemPrompt: 'You are a helpful assistant for software development.',
  ),
  gatewayConnectionId: 'test-gateway-1',
  createdAt: DateTime(2026, 2, 18),
);
```

### Sample Trash Scenario

```dart
final oldDeletedWorkspace = Workspace(
  id: 'old-trash-1',
  identity: WorkspaceIdentity(name: 'Old Workspace'),
  gatewayConnectionId: 'test-gateway-1',
  createdAt: DateTime(2026, 1, 1),
  deletedAt: DateTime.now().subtract(const Duration(days: 35)), // Expired
);

final recentDeletedWorkspace = Workspace(
  id: 'recent-trash-1',
  identity: WorkspaceIdentity(name: 'Recent Workspace'),
  gatewayConnectionId: 'test-gateway-1',
  createdAt: DateTime(2026, 2, 1),
  deletedAt: DateTime.now().subtract(const Duration(days: 5)), // Can restore
);
```

---

## References

- US1 Data Model: `/specs/002-us1-connect-chat/data-model.md`
- Research: `/specs/003-us2-multi-agent-workspace/research.md`
- Spec: `/specs/003-us2-multi-agent-workspace/spec.md`
