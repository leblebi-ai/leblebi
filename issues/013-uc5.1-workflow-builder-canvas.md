## Acceptance Criteria
- [ ] Full-screen canvas with pinch-to-zoom and pan support
- [ ] Left panel palette of draggable nodes: Agent, Trigger, Condition, Transform, Human Approval, Output
- [ ] Connect nodes with drag-from-port-to-port (visual wires with arrows)
- [ ] Tap node opens side sheet with configuration options
- [ ] Top bar with workflow name (editable), Save, Run, Share buttons
- [ ] Mini-map in corner for large workflows
- [ ] All entities generated using ZFA (Zorphy) with JSON serialization
- [ ] All Clean Architecture layers generated using ZFA generate command
- [ ] State management using ZFA-generated State classes

## Task
Implement the visual Workflow Builder canvas for orchestrating agents and actions.

### Screen Layout:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  [Workflow Name âœï¸]              [Save] [Run] [Share]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              â”‚                                    â”‚             â”‚
â”‚   Palette    â”‚         Canvas                     â”‚ Mini-map    â”‚
â”‚              â”‚                                    â”‚             â”‚
â”‚   ğŸ¤– Agent   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”Œâ”€â”€â”€â”€â”€â”     â”‚
â”‚   âš¡ Trigger â”‚   â”‚Triggerâ”‚â”€â”€â”€â”€â”€â–¶â”‚ Agent â”‚       â”‚ â”‚ â–ªâ–ªâ–ª â”‚     â”‚
â”‚   ğŸ”€ Cond.   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”˜       â”‚ â”‚â–ªâ–ª   â”‚     â”‚
â”‚   ğŸ”„ Trans.  â”‚                      â”‚           â”‚ â”‚ â–ªâ–ªâ–ª â”‚     â”‚
â”‚   âœ‹ Approvalâ”‚                  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”       â”‚ â””â”€â”€â”€â”€â”€â”˜     â”‚
â”‚   ğŸ“¤ Output â”‚                  â”‚Output â”‚       â”‚             â”‚
â”‚              â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚             â”‚
â”‚              â”‚                                    â”‚             â”‚
â”‚              â”‚                                    â”‚             â”‚
â”‚              â”‚      [+ Zoom In] [- Zoom Out]     â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Nodes: 3  â”‚  Connections: 2  â”‚  Status: Draft                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Canvas Features:

**Pan & Zoom:**
- Pinch-to-zoom on touch devices
- Mouse wheel to zoom on desktop
- Click and drag to pan
- Min zoom: 25%, Max zoom: 200%
- Zoom controls in bottom-right corner
- Double-tap to fit all nodes

**Grid Background:**
- Subtle dot grid for alignment
- Snap-to-grid when placing/moving nodes
- Grid size: 20px
- Grid toggle in settings

**Selection:**
- Click node to select
- Shift+click for multi-select
- Drag selection box to select multiple
- Selected nodes show border highlight

### Node Palette (Left Panel):

**Palette Nodes:**

1. **ğŸ¤– Agent Node**
   - Drag onto canvas
   - Opens agent picker dialog
   - Shows selected agent's avatar and name
   - Multiple agent nodes allowed

2. **âš¡ Trigger Node**
   - Starting point of workflow
   - Types:
     - Manual (button press)
     - Scheduled (cron expression)
     - Webhook (URL endpoint)
     - File change (watch directory)
     - Email received (inbox trigger)
   - One trigger per workflow

3. **ğŸ”€ Condition Node**
   - Branching logic
   - If/Else based on:
     - Output content (contains, matches regex)
     - Output type (text, file, etc.)
     - Agent status (success, error)
     - Custom expression
   - Two output ports: True/False

4. **ğŸ”„ Transform Node**
   - Process/modify data
   - Operations:
     - Extract (regex, JSON path)
     - Format (template, markdown)
     - Merge (combine multiple inputs)
     - Filter (remove items)
     - Map (transform each item)

5. **âœ‹ Human Approval Node**
   - Pauses workflow
   - Sends notification to user
   - Waits for approval/rejection
   - Optional: Edit before continuing
   - Timeout setting

6. **ğŸ“¤ Output Node**
   - End point of workflow
   - Destination options:
     - Chat (send to agent chat)
     - File (save to location)
     - Notification (push notification)
     - Clipboard (copy to clipboard)
     - Webhook (POST to URL)
     - Email (send to address)
   - Multiple output nodes allowed

**Palette Interaction:**
- Drag node from palette to canvas
- Ghost preview while dragging
- Drop creates node at location
- Nodes auto-arrange on drop (optional)

### Node Design:

**Node Appearance:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â—‹  [ğŸ¤– Agent Name]  â”‚â—‹â”‚  â† Input/Output ports
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚     Email Agent     â”‚
â”‚     Status: Ready   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Node Components:**
1. **Port** (left/right circles)
   - Input ports on left
   - Output ports on right
   - Hover shows port type
2. **Icon** â€” Node type icon
3. **Label** â€” Node name
4. **Details** â€” Brief status/summary
5. **Status Indicator** â€” Color-coded status

**Node States:**
- **Default:** Normal appearance
- **Selected:** Blue border
- **Hover:** Subtle highlight
- **Running:** Pulsing animation
- **Success:** Green checkmark
- **Error:** Red X with error message
- **Waiting:** Amber pulsing (for approval)

### Connection (Wires):

**Creating Connections:**
1. Click and drag from output port
2. Line follows cursor
3. Drop on compatible input port
4. Connection created with animation

**Wire Appearance:**
- Curved bezier line
- Directional arrow
- Animated dots showing data flow when running
- Color-coded by status:
  - Gray: Inactive
  - Blue: Active/selected
  - Green: Data flowing
  - Red: Error

**Deleting Connections:**
- Click wire to select
- Press Delete/Backspace
- Or right-click â†’ Delete connection

### Node Configuration Sheet:

**Triggering:**
- Tap node â†’ Side sheet slides in from right
- Shows configuration options for that node type

**Agent Node Configuration:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Node                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Select Agent               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¤– Email Agent     â–¼â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚
â”‚  Input Variable             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ {{trigger.output}}  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚
â”‚  Timeout (seconds)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 60                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚
â”‚  Retry on failure           â”‚
â”‚  [Toggle]                   â”‚
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Apply           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Trigger Node Configuration:**
- Trigger type selection
- Type-specific options:
  - **Manual:** Button label
  - **Scheduled:** Cron expression builder
  - **Webhook:** Generate URL, show URL
  - **File:** Directory picker, file patterns
  - **Email:** Folder selection, filter rules

**Condition Node Configuration:**
- Condition type dropdown
- Condition expression builder
- Visual expression builder for non-technical users
- Preview of condition logic

**Transform Node Configuration:**
- Operation type selection
- Operation-specific inputs
- Preview of transformation
- Test with sample data

**Approval Node Configuration:**
- Approval message template
- Timeout duration
- Fallback action (auto-approve, auto-reject)
- Notification settings

**Output Node Configuration:**
- Destination type selection
- Destination-specific settings
- Output format options
- Test output button

### Mini-map:

**Location:** Bottom-right corner
**Size:** 150x100px (adjustable)
**Features:**
- Shows entire workflow scaled down
- Current viewport highlighted
- Click to navigate to that area
- Nodes shown as colored dots
- Wires shown as thin lines

### Toolbar (Top Bar):

**Components:**
1. **Back Button (â†)** â€” Navigate back to workflow list
2. **Workflow Name** â€” Editable text field
3. **Save Button** â€” Save workflow (Ctrl/Cmd+S)
4. **Run Button** â€” Execute workflow (enabled if valid)
5. **Share Button** â€” Export or share workflow
6. **Overflow Menu (â‹®):**
   - Duplicate workflow
   - Delete workflow
   - Export as JSON
   - View execution history
   - Workflow settings

### Validation:

**Real-time Validation:**
- Check for disconnected nodes
- Verify all required connections
- Validate node configurations
- Show errors inline
- Disable "Run" if invalid

**Validation Messages:**
- Warning icon on invalid nodes
- Tooltip with error description
- Summary in bottom status bar

### Canvas Actions:

**Undo/Redo:**
- Ctrl/Cmd+Z: Undo
- Ctrl/Cmd+Shift+Z: Redo
- Undo stack: 50 actions

**Keyboard Shortcuts:**
- Delete: Remove selected node/wire
- Ctrl/Cmd+A: Select all
- Ctrl/Cmd+D: Duplicate selected
- Escape: Deselect
- Arrow keys: Move selected node(s)

**Context Menu (Right-click):**
- Edit configuration
- Duplicate
- Delete
- Copy
- Paste

### State Management:

**Workflow Data:**
```javascript
{
  id: string,
  name: string,
  nodes: Node[],
  connections: Connection[],
  viewport: { x, y, zoom },
  createdAt: timestamp,
  updatedAt: timestamp
}

Node {
  id: string,
  type: enum,
  position: { x, y },
  config: object
}

Connection {
  id: string,
  sourceNodeId: string,
  sourcePort: string,
  targetNodeId: string,
  targetPort: string
}
```

### Performance:
- Virtual rendering for large workflows
- Debounced auto-save
- Efficient re-rendering on changes
- WebGL rendering option for complex workflows

## ZFA Architecture Requirements

### Entity Definition

**Workflow Entity:**
```bash
zfa entity create -n Workflow --field "id:String,name:String,description:String?,nodes:List<Map<String,dynamic>>,connections:List<Map<String,dynamic>>,viewportX:double,viewportY:double,viewportZoom:double,createdAt:DateTime,updatedAt:DateTime" --json
```

**WorkflowNode Entity:**
```bash
zfa entity create -n WorkflowNode --field "id:String,workflowId:String,type:String,positionX:double,positionY:double,config:Map<String,dynamic>,createdAt:DateTime" --json
```

**NodeType Enum:**
```bash
zfa entity enum -n NodeType --value agent,trigger,condition,transform,approval,output
```

### Clean Architecture Generation

```bash
zfa generate Workflow --methods=get,getList,create,update,delete --data --vpc --state
zfa generate WorkflowNode --methods=get,getList,create,update,delete --data --vpc --state
```

### Implementation Notes

1. **Node Serialization**: Store nodes as JSON in `nodes` field or use separate `WorkflowNode` entities
2. **Connection Validation**: Validate connections before save
3. **Auto-save**: Debounce save calls, store draft locally

