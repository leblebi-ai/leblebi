## Acceptance Criteria
- [ ] Long-press any message shows "Branch from here" option
- [ ] Creates a fork of the conversation at that point
- [ ] Branch indicator in timeline (fork icon)
- [ ] User can switch between branches via dropdown or swipe gesture
- [ ] Branches persist and can be named/renamed
- [ ] All entities generated using ZFA (Zorphy) with JSON serialization
- [ ] All Clean Architecture layers generated using ZFA generate command
- [ ] State management using ZFA-generated State classes

## Task
Implement chat branching functionality for exploring different conversation paths without losing context.

### Branching Concept:
Chat branching allows users to fork a conversation at any point, creating an alternate timeline. This is useful for:
- Exploring different approaches to the same question
- Trying different prompts without losing the original conversation
- Comparing different agent responses to the same context

### Branch Creation:

**Trigger:**
Long-press on any message â†’ Context menu with "Branch from here" option

**Branch Creation Flow:**
1. User long-presses message
2. Selects "Branch from here" (ğŸŒ¿ or fork icon)
3. Dialog appears:
   - Branch name field (optional, auto-generates "Branch 1", "Branch 2", etc.)
   - "Create Branch" button
4. Branch is created with all messages up to and including the selected message
5. User is switched to the new branch

**Visual Feedback:**
- Animation showing conversation splitting
- Fork icon (ğŸŒ¿) appears in timeline at branch point
- Toast message: "Created branch: [Branch name]"

### Branch Visualization:

**Timeline Indicator:**
At the branch point, show:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Original message here              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      ğŸŒ¿ Branch from here
      â”œâ”€â”€ Main
      â””â”€â”€ Branch 1
```

**Branch Selector:**
- Dropdown or pill selector near the branch point
- Shows all branches from that point
- Current branch highlighted
- Count badge showing number of branches

**Alternative: Swipe Gesture**
- Swipe left/right on branch point to switch branches
- Visual: conversation slides, new branch content appears
- Haptic feedback on branch switch

### Branch UI:

**Header Indicator:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  Agent Name                      â”‚
â”‚      ğŸŒ¿ Branch 1        [Main â–¼]    â”‚  â† Branch selector dropdown
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

**Dropdown Contents:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Main (original)     â”‚  â† Original conversation
â”‚ Branch 1            â”‚  â† User-created branches
â”‚ Branch 2            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ + Create new branch â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Branch Navigation:

**Switch Branch:**
1. Tap branch selector dropdown
2. Select desired branch
3. Chat content updates to show that branch's messages
4. Branch indicator updates

**Swipe Gesture (Mobile):**
1. Locate branch point (visual indicator)
2. Swipe left for next branch, right for previous
3. Smooth transition between branch content
4. Branch name updates in header

**Keyboard Shortcut (Desktop):**
- `Cmd+B` to open branch selector
- Arrow keys to navigate branches
- Enter to select

### Branch Management:

**Branch Actions:**
From branch selector dropdown:
- **Rename** â€” Edit branch name
- **Delete** â€” Remove branch (confirmation required)
- **Merge to Main** â€” Copy branch content to main (advanced)

**Branch List View:**
Accessible from overflow menu â†’ "View all branches":
- List of all branches with:
  - Branch name
  - Creation date
  - Message count
  - Preview of first divergent message
- Tap to navigate to that branch
- Swipe to delete

### Branch Content:

**Shared Messages:**
- Messages before branch point are shared across all branches
- Edits to shared messages affect all branches
- Deleting shared messages requires confirmation (affects all branches)

**Branch-Specific Messages:**
- Messages after branch point are unique to each branch
- New messages added to current branch only
- No cross-branch contamination

### Use Case Examples:

**1. Different Prompts:**
```
Main:
User: "Help me write a blog post"
Agent: [Writes formal blog post]
User: "Make it more casual"
Agent: [Revises to casual tone]

Branch 1 (from first response):
User: "Make it more technical"
Agent: [Revises to technical tone]

Branch 2 (from first response):
User: "Write it in Spanish"
Agent: [Translates to Spanish]
```

**2. Different Approaches:**
```
Main:
User: "How should I structure my app?"
Agent: [Suggests MVC architecture]
User: "What are the benefits?"
Agent: [Explains MVC benefits]

Branch 1:
User: "What about MVVM?"
Agent: [Explains MVVM comparison]

Branch 2:
User: "What about Clean Architecture?"
Agent: [Explains Clean Architecture]
```

**3. Comparing Outputs:**
```
Main:
User: "Summarize this article"
Agent: [Detailed summary]

Branch 1:
Agent: [Brief summary]

Branch 2:
Agent: [Bullet-point summary]
```

### State Management:

**Branch Data Structure:**
```
Chat {
  id: string
  messages: Message[]
  branches: Branch[]
}

Branch {
  id: string
  name: string
  parentMessageId: string  // Branch point
  messages: Message[]      // Branch-specific messages
  createdAt: timestamp
}

Message {
  id: string
  branchId: string | null  // null = main
  content: string
  timestamp: timestamp
  ...
}
```

**Persistence:**
- Branches persist in local storage
- Synced to cloud if applicable
- Loaded on-demand for performance

### Visual Design:

**Branch Point Marker:**
- Subtle fork icon (ğŸŒ¿) in timeline
- Vertical line showing branch diverges
- Color coding for each branch (optional)

**Current Branch Indicator:**
- Pill/badge in header
- Distinct color for current branch
- Arrow showing it's a dropdown

**Transition Animation:**
- Slide animation when switching branches
- Fade for shared messages
- Slide direction matches swipe gesture

### Performance:
- Lazy load branch content
- Cache current branch
- Pre-fetch adjacent branches
- Virtual scrolling for long branches

## ZFA Architecture Requirements

### Entity Definition

**Branch Entity:**
```bash
zfa entity create -n Branch --field "id:String,chatId:String,name:String,parentMessageId:String,createdAt:DateTime" --json
```

**BranchMessage Entity:**
```bash
zfa entity create -n BranchMessage --field "id:String,branchId:String,messageId:String,createdAt:DateTime" --json
```

### Clean Architecture Generation

```bash
zfa generate Branch --methods=get,getList,create,delete --data --vpc --state
zfa generate BranchMessage --methods=get,getList,create --data --vpc --state
```

### Implementation Notes

1. **Shared Messages**: Messages before `parentMessageId` are shared across all branches
2. **Branch-Specific**: Messages after branch point are linked via `BranchMessage`
3. **Switch Branch**: Load messages from different branch, maintain scroll position

