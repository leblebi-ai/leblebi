## Acceptance Criteria
- [ ] Full-screen chat view with agent avatar and name in app bar
- [ ] Message bubbles: user on right, agent on left
- [ ] Rich content support: markdown, code blocks, tables, images, files, action buttons
- [ ] Typing indicator with animated dots when agent is processing
- [ ] Input bar with text field, attachment, voice input, and send buttons
- [ ] Pull-down for older messages (paginated)
- [ ] All entities generated using ZFA (Zorphy) with JSON serialization
- [ ] All Clean Architecture layers generated using ZFA generate command
- [ ] State management using ZFA-generated State classes

## Task
Implement the single agent chat interface that serves as the core interaction loop between user and agent.

### Screen Layout:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  [Avatar] Agent Name      â‹®     â”‚  â† App Bar
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Agent message      â”‚            â”‚  â† Agent bubble (left)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚            â”‚ User message       â”‚  â”‚  â† User bubble (right)
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Rich content...    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                     â”‚
â”‚  â— â— â—  typing...                  â”‚  â† Typing indicator
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“  [Type a message...    ]  ğŸ¤ â¤â”‚  â† Input bar
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### App Bar:
- Back button (â†)
- Agent avatar (circular, 32-40px)
- Agent name (bold)
- Status indicator dot (green=idle, blue=working, amber=waiting)
- Overflow menu (â‹®):
  - "Clear chat"
  - "Export chat"
  - "Agent settings"
  - "View logs"

### Message Bubbles:

**User Messages (Right-aligned):**
- Background: Accent color or user's color
- Text: White or contrast color
- Rounded corners (more on right side)
- Max width: 70-80% of screen width
- Padding: 12px
- Message content + timestamp (bottom-right, small)

**Agent Messages (Left-aligned):**
- Background: Surface color or light gray
- Text: Primary text color
- Rounded corners (more on left side)
- Max width: 70-80% of screen width
- Padding: 12px
- Message content + timestamp (bottom-left, small)

### Rich Content Support:

**1. Markdown Rendering:**
- Headings (h1-h6)
- Bold, italic, strikethrough
- Lists (ordered and unordered)
- Links (tappable, open in browser or in-app)
- Blockquotes
- Horizontal rules

**2. Code Blocks:**
- Syntax highlighting for common languages
- Language label at top
- Copy button (copies code to clipboard)
- Horizontal scroll for long lines
- Monospace font
- Dark background for contrast

**3. Tables:**
- Formatted table rendering
- Header row with styling
- Horizontal scroll for wide tables
- Alternating row colors (optional)

**4. Images:**
- Inline thumbnail with max height
- Tap to open fullscreen viewer
- Pinch to zoom
- Share/download options

**5. File Attachments:**
- File icon based on type
- File name + size
- Tap to preview (if supported)
- Tap to download
- Long-press for options (share, save, open with)

**6. Action Buttons:**
- Rendered as inline buttons within message
- Examples: "Approve", "Edit", "Retry", "Send this email"
- Buttons trigger actions relevant to context
- See UC-3.3 for approval implementation

### Typing Indicator:
- Three animated dots: â— â— â—
- Animation: Sequential bounce or pulse
- Text: "[Agent name] is typing..."
- Appears when agent is processing
- Disappears when response starts streaming

### Input Bar:

**Components:**
1. **Attachment Button** (ğŸ“)
   - Opens file picker
   - Options: Photo, File, Camera, Clipboard
   - Show preview of attached file before sending

2. **Text Field**
   - Placeholder: "Type a message..."
   - Auto-expand (up to 5 lines)
   - Multiline support
   - Character counter (if limit exists)

3. **Voice Input Button** (ğŸ¤)
   - Hold to record
   - Release to send
   - Shows recording duration
   - Transcribes speech to text
   - Cancel by sliding up

4. **Send Button** (â¤)
   - Enabled only when text field has content
   - Tap to send message
   - Animation on send

### Message Input Features:
- Send on Enter (configurable)
- Shift+Enter for new line
- Draft saving (restore on app return)
- Edit last message (long-press own message)

### Message Actions:
Long-press on message shows:
- **Copy** â€” Copy message text
- **Select Text** â€” Highlight portion to copy
- **Branch from here** â€” See UC-3.4
- **Delete** â€” Remove message (own messages only)

### Pagination:
- Pull-down gesture to load older messages
- Loading indicator at top
- Batch load (e.g., 20 messages at a time)
- Scroll position maintained after load
- "Start of conversation" indicator

### Streaming Responses:
- Agent responses stream in real-time
- Text appears character by character or word by word
- Smooth typing animation
- User can scroll during streaming
- Stop generation button during streaming

### State Management:
- Track message list with metadata
- Track streaming state
- Track input draft
- Track attachment state
- Persist messages to local storage
- Sync with backend if applicable

### Error Handling:
- Failed messages show retry button
- Network errors show indicator
- Long-press failed message to retry or delete
- Offline indicator when disconnected

### Accessibility:
- Screen reader announcements for new messages
- Semantic labels for all interactive elements
- Adjustable text size
- High contrast mode support

## ZFA Architecture Requirements

### Entity Definition

**Message Entity:**
```bash
zfa entity create -n Message --field "id:String,chatId:String,senderType:String,senderId:String,senderName:String,content:String,contentType:String,attachments:List<Map<String,dynamic>>?,metadata:Map<String,dynamic>?,createdAt:DateTime" --json
```

**Chat Entity:**
```bash
zfa entity create -n Chat --field "id:String,agentId:String,title:String?,lastMessageAt:DateTime,unreadCount:int,createdAt:DateTime" --json
```

**Attachment Entity:**
```bash
zfa entity create -n Attachment --field "id:String,messageId:String,type:String,name:String,url:String,size:int,mimeType:String" --json
```

### Clean Architecture Generation

```bash
zfa generate Message --methods=get,getList,create --data --vpc --state
zfa generate Chat --methods=get,getList,create,update,delete --data --vpc --state
zfa generate Attachment --methods=get,create --data --vpc --state
```

### Generated State for Chat

```dart
class MessageState {
  final AppFailure? error;
  final List<Message> messageList;
  final Message? message;
  final bool isGetting;
  final bool isGettingList;
  final bool isCreating;
  
  bool get isLoading => isGetting || isGettingList || isCreating;
  bool get hasError => error != null;
}
```

### Implementation Notes

1. **Pagination**: Use `ListQueryParams.limit` and `offset` for message pagination
2. **Streaming**: Implement real-time message streaming in data source
3. **Rich Content**: Store content type and parse accordingly in view

