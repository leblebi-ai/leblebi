## Acceptance Criteria
- [ ] Action preview cards appear when agent wants to perform real actions
- [ ] Preview card shows action title, expandable body, Approve/Reject buttons
- [ ] "Edit before sending" option opens editable view
- [ ] Approval history section in chat (collapsible)
- [ ] Batch approval for multiple queued actions
- [ ] All entities generated using ZFA (Zorphy) with JSON serialization
- [ ] All Clean Architecture layers generated using ZFA generate command
- [ ] State management using ZFA-generated State classes

## Task
Implement inline approvals and human-in-the-loop functionality for safe agent actions.

### Action Preview Card:

**Trigger:**
When an agent wants to perform a "real" action (send email, create file, make API call, etc.), it sends an approval request instead of executing immediately.

**Card Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Action Requires Approval        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“§ Send email to john@example.com  â”‚  â† Title with icon
â”‚                                     â”‚
â”‚  [â–¼ Show content]                   â”‚  â† Expandable
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Subject: Meeting Follow-up  â”‚   â”‚  â† Expanded content
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ Hi John,                    â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ Following up on our         â”‚   â”‚
â”‚  â”‚ discussion yesterday...     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ âœï¸ Edit   â”‚ â”‚ âŒ Reject â”‚      â”‚  â† Action buttons
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚     âœ… Approve           â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Card Components:

**1. Title Bar:**
- Warning icon (âš ï¸) or action-type icon
- "Action Requires Approval" or specific action type
- Timestamp

**2. Action Summary:**
- Icon based on action type:
  - ğŸ“§ Email
  - ğŸ“„ File creation
  - ğŸŒ API call
  - ğŸ“… Calendar event
  - ğŸ’³ Payment
  - ğŸ”§ System change
- Clear description of what will happen
- Example: "Send email to john@example.com"

**3. Expandable Content:**
- Collapsed by default (show "Show content" link)
- Tap to expand full action details
- For emails: Subject, body, attachments
- For files: File name, content preview, location
- For API calls: Endpoint, method, payload
- For calendar: Event title, time, attendees, description

**4. Action Buttons:**

**Edit (Optional):**
- Pencil icon + "Edit"
- Opens editable view of action content
- User can modify before approving
- Returns to preview with changes

**Reject:**
- X icon + "Reject"
- Red/danger color
- Immediate rejection (no confirmation)
- Agent receives rejection feedback

**Approve:**
- Checkmark icon + "Approve"
- Green/success color
- Prominent styling (filled button)
- Executes the action immediately

### Edit Before Sending:

**Editable View:**
When user taps "Edit", show full-screen editor:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Edit Email              Cancel  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  To: john@example.com        [âœï¸]  â”‚
â”‚  Subject: Meeting Follow-up   [âœï¸]  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Hi John,                    â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ Following up on our         â”‚   â”‚
â”‚  â”‚ discussion yesterday...     â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ [Cursor here for editing]   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚     Save Changes         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Editable Fields:**
- Email: To, CC, Subject, Body
- File: Name, Content, Location
- API: Payload (JSON editor)
- Calendar: Title, Time, Description, Attendees

### Approval History:

**Location:**
Collapsible section above input bar or in overflow menu.

**Content:**
- List of all approval actions in conversation
- Each entry shows:
  - Action type icon
  - Summary
  - Status badge: âœ… Approved / âŒ Rejected / â³ Pending
  - Timestamp
- Tap to see full details or undo (if supported)

**Format:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Approval History (3 actions)    â–¼  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Send email to john@...  2:45pm  â”‚
â”‚  âŒ Create file report.pdf  2:30pm  â”‚
â”‚  âœ… Schedule meeting        1:15pm  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Batch Approval:

**Trigger:**
When multiple actions queue up (3+), show stacked card:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ 3 Actions Pending Approval      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“§ Send email to john@...         â”‚
â”‚  ğŸ“„ Create file report.pdf         â”‚
â”‚  ğŸ“… Schedule meeting with team      â”‚
â”‚                                     â”‚
â”‚  [â–¼ Expand to review each]          â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Approve All (3)       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Reject All            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Expanded View:**
- Each action shown individually with Approve/Reject buttons
- "Approve All" / "Reject All" buttons remain
- User can mix: approve some, reject others

### Action Types & Permissions:

**Requires Approval (Default):**
- Sending emails
- Creating/modifying files
- Making external API calls
- Scheduling calendar events
- Making payments
- Modifying system settings
- Deleting data

**Auto-Approved (Configurable):**
- Web searches
- Reading files (non-sensitive)
- Simple calculations
- Generating text content

**Permission Levels:**
Per-agent settings (in UC-4.1):
- **Full Autonomy:** No approval required for this agent
- **Ask for Critical Actions:** Only risky actions need approval
- **Ask for Everything:** All actions need approval (default)
- **No Actions Allowed:** Agent cannot perform any real actions

### Notification Integration:
- Pending approval shows in notification center (UC-7.1)
- Push notification: "Agent waiting for your approval"
- Badge count shows pending approvals
- Tap notification â†’ navigate to chat with pending action

### Timeout Handling:
- Actions expire after configurable timeout (default: 24 hours)
- Expired actions show "Expired" status
- Agent notified of expiration
- User can still review expired actions

### State Management:
- Track pending approvals per agent
- Track approval history per conversation
- Track approval/rejection timestamps
- Sync approval state with agent

### Security:
- Approval requests are signed/authenticated
- User identity verified before executing
- Audit log of all approvals
- Rate limiting on approval requests

## ZFA Architecture Requirements

### Entity Definition

**ApprovalRequest Entity:**
```bash
zfa entity create -n ApprovalRequest --field "id:String,agentId:String,chatId:String,actionType:String,title:String,body:String,expandedBody:String?,status:String,createdAt:DateTime,respondedAt:DateTime?,metadata:Map<String,dynamic>?" --json
```

**ApprovalStatus Enum:**
```bash
zfa entity enum -n ApprovalStatus --value pending,approved,rejected,expired
```

### Clean Architecture Generation

```bash
zfa generate ApprovalRequest --methods=get,getList,create,update --data --vpc --state
```

### Implementation Notes

1. **Create on Agent Request**: Agent sends approval request via `CreateApprovalRequestUseCase`
2. **Update on Response**: Use `UpdateApprovalRequestUseCase` to set status
3. **Batch Display**: Query pending requests and display in stacked card

